name: Extract closed issues

on:
  workflow_dispatch:          # æ‰‹åŠ¨æŒ‰é’®è§¦å‘
  schedule:
    - cron: '0 7 * * *'       # æ¯å¤©æ—©ä¸Š 07:00 UTC (åŒ—äº¬æ—¶é—´15:00)
  issues:
    types: [closed]           # å½“issueè¢«å…³é—­æ—¶è§¦å‘

jobs:
  dump:
    runs-on: ubuntu-latest
    permissions:
      issues: read            # åªéœ€è¯»æƒé™
      contents: write         # å¦‚æœæƒ³æŠŠç»“æœ push å›ä»“åº“
    steps:
      - uses: actions/checkout@v4   # å…ˆæŠŠä»“åº“ä»£ç æ‹‰ä¸‹æ¥ï¼Œæ–¹ä¾¿å†™æ–‡ä»¶

      - name: Install GitHub CLI
        run: sudo apt update && sudo apt install -y gh

      - name: Fetch and parse all issues
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # è·å–æ‰€æœ‰å­˜åœ¨çš„prompt-extraction issuesï¼ˆåŒ…æ‹¬å¼€æ”¾å’Œå…³é—­çš„ï¼‰
          echo "è·å–æ‰€æœ‰å­˜åœ¨çš„prompt-extraction issues..."
          gh api repos/${{ github.repository }}/issues \
             -X GET -f labels=prompt-extraction -f per_page=100 --paginate \
             --jq '[ .[] | .number ]' \
             > existing_issues.json
          
          # è·å–å·²å…³é—­çš„prompt-extraction issueså¹¶è§£æå­—æ®µ
          echo "è·å–å·²å…³é—­çš„prompt-extraction issues..."
          gh api repos/${{ github.repository }}/issues \
             -X GET -f state=closed -f labels=prompt-extraction -f per_page=100 --paginate \
             --jq '[ .[] |
               {
                 updated_at: .updated_at,
                 prompt_title: (.body | match("### ğŸ¯ Promptæ ‡é¢˜\r?\n.*?\r?\n([^\r\n]+)"; "g").captures[0].string // ""),
                 creator: (.body | match("### ğŸ‘¤ ä½œè€…\r?\n.*?\r?\n([^\r\n]+)"; "g").captures[0].string // ""),
                 prompt_content: (
                   # æå–å®Œæ•´çš„promptå†…å®¹ï¼ŒåŒ…æ‹¬å¤šè¡Œ
                   (.body | match("### ğŸ“„ å®Œæ•´Prompt\r?\n.*?\r?\n((?:.|\r?\n)*?)(?=### |\r?\n\r?\n### |\r?\n$|$)"; "g").captures[0].string // "") |
                   # æ¸…ç†å¤šä½™çš„æ¢è¡Œå’Œç©ºæ ¼
                   gsub("[\r\n]+"; " ") |
                   gsub(" +"; " ") |
                   sub("^ +"; "") |
                   sub(" +$"; "")
                 ),
                 model_name: (.body | match("### ğŸ¤– æ¨¡å‹åç§°\r?\n.*?\r?\n([^\r\n]+)"; "g").captures[0].string // ""),
                 other_parameters: (.body | match("### âš™ï¸ å…¶ä»–å‚æ•° \\(å¯é€‰\\)\r?\n.*?\r?\n([^\r\n]+)"; "g").captures[0].string // ""),
                 image_url: (
                   # æå–å›¾ç‰‡URLï¼ŒåŒ…æ‹¬GitHubä¸Šä¼ çš„å›¾ç‰‡å’Œtextareaä¸­çš„å¤šè¡Œå†…å®¹
                   (.body | match("### ğŸ–¼ï¸ æ•ˆæœå›¾URLæˆ–ä¸Šä¼ å›¾ç‰‡\r?\n.*?\r?\n((?:.|\r?\n)*?)(?=### |\r?\n\r?\n### |\r?\n$|$)"; "g").captures[0].string // "") |
                   # æå–GitHubå›¾ç‰‡é“¾æ¥
                   capture("https?://[^\\s\\)]+") |
                   .string // ""
                 ),
                 tags: (.body | match("### ğŸ·ï¸ æ ‡ç­¾\r?\n.*?\r?\n([^\r\n]+)"; "g").captures[0].string // ""),
                 nsfw_content: (
                   # æå–NSFWå¤é€‰æ¡†çŠ¶æ€ï¼Œç°åœ¨åªæœ‰ä¸€ä¸ªé€‰é¡¹ï¼Œé»˜è®¤ä¸ºSFW
                   if (.body | test("\\[x\\].*æˆäººå†…å®¹ \\(NSFW\\)")) then "NSFW" else "SFW" end
                 )
               }
             ]' \
             | jq '.' \
             > closed_issues.json

          # å¦‚æœå­˜åœ¨ç°æœ‰çš„prompts.jsonï¼Œè¿‡æ»¤æ‰å·²åˆ é™¤çš„issues
          if [ -f prompts.json ]; then
            echo "è¿‡æ»¤å·²åˆ é™¤çš„issues..."
            jq --slurpfile existing existing_issues.json '
              map(
                select(.number as $issue_num |
                  $existing[0] | index($issue_num) >= 0
                )
              )
            ' prompts.json > filtered_prompts.json
            
            # åˆå¹¶æ–°çš„å…³é—­issueså’Œè¿‡æ»¤åçš„ç°æœ‰æ•°æ®
            jq -s '.[0] + .[1] | unique_by(.number)' filtered_prompts.json closed_issues.json > prompts.json
          else
            echo "é¦–æ¬¡åˆ›å»ºprompts.json..."
            cp closed_issues.json prompts.json
          fi

          echo "æå–å®Œæˆï¼Œprompts.jsonå·²ä¿å­˜åˆ°æ ¹ç›®å½•"
          ls -la prompts.json

      # æäº¤ç»“æœå›ä»“åº“
      - name: Commit & push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add prompts.json
          git diff --cached --quiet || (
            git commit -m "update prompts data $(date '+%Y-%m-%d %H:%M:%S')" &&
            git pull --rebase origin master &&
            git push
          )