name: Extract closed issues

on:
  workflow_dispatch:          # æ‰‹åŠ¨æŒ‰é’®è§¦å‘
  schedule:
    - cron: '0 7 * * *'       # æ¯å¤©æ—©ä¸Š 07:00 UTC (åŒ—äº¬æ—¶é—´15:00)
  issues:
    types: [closed]           # å½“issueè¢«å…³é—­æ—¶è§¦å‘

jobs:
  dump:
    runs-on: ubuntu-latest
    permissions:
      issues: read            # åªéœ€è¯»æƒé™
      contents: write         # å¦‚æœæƒ³æŠŠç»“æœ push å›ä»“åº“
    steps:
      - uses: actions/checkout@v4   # å…ˆæŠŠä»“åº“ä»£ç æ‹‰ä¸‹æ¥ï¼Œæ–¹ä¾¿å†™æ–‡ä»¶

      - name: Install GitHub CLI
        run: sudo apt update && sudo apt install -y gh

      - name: Fetch and parse closed issues
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # è·å–å·²å…³é—­çš„prompt-extraction issueså¹¶è§£æç»“æ„åŒ–æ•°æ®
          gh api repos/${{ github.repository }}/issues \
             -X GET -f state=closed -f labels=prompt-extraction -f per_page=100 --paginate \
             --jq '[ .[] |
               {
                 number,
                 title,
                 state,
                 created_at,
                 closed_at,
                 updated_at,
                 user: {login: .user.login, id: .user.id},
                 labels: [.labels[] | .name],
                 parsed_data: (
                   # è§£æYAMLæ ¼å¼çš„issue body
                   try (
                     # æå–å„ä¸ªå­—æ®µçš„å€¼
                     {
                       prompt_title: (.body | match("### ğŸ¯ Promptæ ‡é¢˜\r?\n.*?\r?\n([^\r\n]+)"; "g").captures[0].string // ""),
                       creator: (.body | match("### ğŸ‘¤ ä½œè€…\r?\n.*?\r?\n([^\r\n]+)"; "g").captures[0].string // ""),
                       prompt_content: (.body | match("### ğŸ“„ å®Œæ•´Prompt\r?\n.*?\r?\n([^\r\n]+)"; "g").captures[0].string // ""),
                       model_name: (.body | match("### ğŸ¤– æ¨¡å‹åç§°\r?\n.*?\r?\n([^\r\n]+)"; "g").captures[0].string // ""),
                       other_parameters: (.body | match("### âš™ï¸ å…¶ä»–å‚æ•° \\(å¯é€‰\\)\r?\n.*?\r?\n([^\r\n]+)"; "g").captures[0].string // ""),
                       image_url: (
                         # æå–å›¾ç‰‡URLï¼ŒåŒ…æ‹¬GitHubä¸Šä¼ çš„å›¾ç‰‡å’Œtextareaä¸­çš„å¤šè¡Œå†…å®¹
                         (.body | match("### ğŸ–¼ï¸ æ•ˆæœå›¾URLæˆ–ä¸Šä¼ å›¾ç‰‡\r?\n.*?\r?\n([^\r\n]+(?:\r?\n[^\r\n]+)*)"; "g").captures[0].string // "") |
                         capture("https?://[^\\s\\)]+") |
                         .string // ""
                       ),
                       tags: (.body | match("### ğŸ·ï¸ æ ‡ç­¾\r?\n.*?\r?\n([^\r\n]+)"; "g").captures[0].string // ""),
                       nsfw_content: (
                         # æå–NSFWå¤é€‰æ¡†çŠ¶æ€ï¼Œç°åœ¨åªæœ‰ä¸€ä¸ªé€‰é¡¹ï¼Œé»˜è®¤ä¸ºSFW
                         if (.body | test("\\[x\\].*æˆäººå†…å®¹ \\(NSFW\\)")) then "NSFW" else "SFW" end
                       )
                     }
                   ) catch null
                 ),
                 raw_body: .body
               }
             ]' \
             | jq '.' \
             > prompts.json

          echo "æå–å®Œæˆï¼Œprompts.jsonå·²ä¿å­˜åˆ°æ ¹ç›®å½•"
          ls -la prompts.json

      # æäº¤ç»“æœå›ä»“åº“
      - name: Commit & push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add prompts.json
          git diff --cached --quiet || (git commit -m "update prompts data $(date '+%Y-%m-%d %H:%M:%S')" && git push)