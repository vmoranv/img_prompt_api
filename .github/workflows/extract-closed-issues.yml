name: Extract closed issues

on:
  workflow_dispatch:          # æ‰‹åŠ¨æŒ‰é’®è§¦å‘
  schedule:
    - cron: '0 7 * * *'       # æ¯å¤©æ—©ä¸Š 07:00 UTC (åŒ—äº¬æ—¶é—´15:00)
  issues:
    types: [closed]           # å½“issueè¢«å…³é—­æ—¶è§¦å‘

jobs:
  dump:
    runs-on: ubuntu-latest
    permissions:
      issues: read            # åªéœ€è¯»æƒé™
      contents: write         # å¦‚æœæƒ³æŠŠç»“æœ push å›ä»“åº“
    steps:
      - uses: actions/checkout@v4   # å…ˆæŠŠä»“åº“ä»£ç æ‹‰ä¸‹æ¥ï¼Œæ–¹ä¾¿å†™æ–‡ä»¶

      - name: Install GitHub CLI
        run: sudo apt update && sudo apt install -y gh

      - name: Fetch and parse all issues
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # è·å–æ‰€æœ‰å­˜åœ¨çš„prompt-extraction issuesï¼ˆåŒ…æ‹¬å¼€æ”¾å’Œå…³é—­çš„ï¼‰
          echo "è·å–æ‰€æœ‰å­˜åœ¨çš„prompt-extraction issues..."
          gh api repos/${{ github.repository }}/issues \
             -X GET -f labels=prompt-extraction -f per_page=100 --paginate \
             --jq '[ .[] | .number ]' \
             > existing_issues.json
          
          # è·å–å·²å…³é—­çš„prompt-extraction issueså¹¶è§£æå­—æ®µ
          echo "è·å–å·²å…³é—­çš„prompt-extraction issues..."
          gh api repos/${{ github.repository }}/issues \
             -X GET -f state=closed -f labels=prompt-extraction -f per_page=100 --paginate \
             --jq '[ .[] |
               {
                 number: .number,
                 updated_at: .updated_at,
                 prompt_title: (.body | match("### ğŸ¯ Promptæ ‡é¢˜\r?\n.*?\r?\n([^\r\n]+)"; "g").captures[0].string // ""),
                 creator: (.body | match("### ğŸ‘¤ ä½œè€…\r?\n.*?\r?\n([^\r\n]+)"; "g").captures[0].string // ""),
                 prompt_content: (
                   # æå–å®Œæ•´çš„promptå†…å®¹ï¼ŒåŒ…æ‹¬å¤šè¡Œ
                   (.body | match("### ğŸ“„ å®Œæ•´Prompt\r?\n.*?\r?\n((?:.|\r?\n)*?)\r?\n###"; "g").captures[0].string // "") |
                   # æ¸…ç†markdownè¯­æ³•å’Œå¤šä½™çš„æ¢è¡Œç©ºæ ¼
                   gsub("```[a-zA-Z]*"; "") |           # ç§»é™¤ä»£ç å—æ ‡è®°
                   gsub("```"; "") |                    # ç§»é™¤ç»“æŸä»£ç å—æ ‡è®°
                   gsub("[\r\n]+"; " ") |               # æ¸…ç†æ¢è¡Œ
                   gsub(" +"; " ") |                    # æ¸…ç†å¤šä½™ç©ºæ ¼
                   sub("^ +"; "") |                     # ç§»é™¤å¼€å¤´ç©ºæ ¼
                   sub(" +$"; "")                       # ç§»é™¤ç»“å°¾ç©ºæ ¼
                 ),
                 model_name: (.body | match("### ğŸ¤– æ¨¡å‹åç§°\r?\n.*?\r?\n([^\r\n]+)"; "g").captures[0].string // ""),
                 other_parameters: (.body | match("### âš™ï¸ å…¶ä»–å‚æ•° \\(å¯é€‰\\)\r?\n.*?\r?\n([^\r\n]+)"; "g").captures[0].string // ""),
                 image_url: (
                   # æå–å›¾ç‰‡URLï¼ŒåŒ…æ‹¬GitHubä¸Šä¼ çš„å›¾ç‰‡å’Œtextareaä¸­çš„å¤šè¡Œå†…å®¹
                   (.body | match("### ğŸ–¼ï¸ æ•ˆæœå›¾URLæˆ–ä¸Šä¼ å›¾ç‰‡\r?\n.*?\r?\n((?:.|\r?\n)*?)\r?\n###"; "g").captures[0].string // "") |
                   # æå–GitHubå›¾ç‰‡é“¾æ¥ï¼Œæ”¯æŒmarkdownæ ¼å¼ ![Image](url) å’Œç›´æ¥URL
                   (if test("!\\[.*?\\]\\(https?://") then
                     match("!\\[.*?\\]\\((https?://[^\\)]+)\\)"; "g").captures[0].string // ""
                   else
                     capture("https?://[^\\s\\)]+") | .string // ""
                   end)
                 ),
                 tags: (.body | match("### ğŸ·ï¸ æ ‡ç­¾\r?\n.*?\r?\n([^\r\n]+)"; "g").captures[0].string // ""),
                 nsfw_content: (
                   # æå–NSFWå¤é€‰æ¡†çŠ¶æ€ï¼Œç°åœ¨åªæœ‰ä¸€ä¸ªé€‰é¡¹ï¼Œé»˜è®¤ä¸ºSFW
                   if (.body | test("\\[x\\].*æˆäººå†…å®¹ \\(NSFW\\)")) then "NSFW" else "SFW" end
                 )
               }
             ]' \
             | jq '.' \
             > closed_issues.json

          # å¦‚æœå­˜åœ¨ç°æœ‰çš„prompts.jsonï¼Œåˆå¹¶æ‰€æœ‰å…³é—­çš„issues
          if [ -f prompts.json ]; then
            echo "åˆå¹¶æ‰€æœ‰å…³é—­çš„issuesåˆ°ç°æœ‰prompts.json..."
            
            # åˆå¹¶ç°æœ‰çš„promptså’Œæ‰€æœ‰å…³é—­çš„issuesï¼ŒæŒ‰numberå»é‡
            jq -s '.[0] + .[1] | unique_by(.number)' prompts.json closed_issues.json > prompts_updated.json
            mv prompts_updated.json prompts.json
            
            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            rm -f existing_prompt_numbers.json new_closed_issues.json filtered_prompts.json
          else
            echo "é¦–æ¬¡åˆ›å»ºprompts.json..."
            cp closed_issues.json prompts.json
          fi

          echo "æå–å®Œæˆï¼Œprompts.jsonå·²ä¿å­˜åˆ°æ ¹ç›®å½•"
          ls -la prompts.json

      # æäº¤ç»“æœå›ä»“åº“
      - name: Commit & push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add prompts.json
          git diff --cached --quiet || (
            git commit -m "update prompts data $(date '+%Y-%m-%d %H:%M:%S')" &&
            git pull --rebase origin master &&
            git push
          )